#!/bin/sh
# ~/.local/bin/rssadd_prompt.sh

# Prompt user for URL input with rofi
input=$(rofi -dmenu -p "RSS URL or HTML file:" -lines 0)

# Exit if nothing entered
[ -z "$input" ] && exit 0

# If input is a file, extract RSS link from it
if [ -f "$input" ]; then
    url=$(grep -Eom1 '<[^>]+(rel="self"|application/[a-z]+\+xml)[^>]+>' "$input" \
        | grep -o "https?://[^\" ]")
else
    url="$input"
fi

# Fallback: try clipboard if input is empty
if [ -z "$url" ]; then
    url=$(xclip -selection clipboard -o 2>/dev/null)
fi

# Validate URL using regex
if ! echo "$url" | grep -Eq '^https?://[^/ ]+\.[^ ]+'; then
    notify-send "Invalid URL. Nothing added."
    exit 1
fi

# RSS file path
RSSFILE="${XDG_CONFIG_HOME:-$HOME/.config}/newsboat/urls"

# Check for duplicates
if awk '{print $1}' "$RSSFILE" | grep -Fxq "$url"; then
    notify-send "RSS feed already exists."
    exit 0
fi

# Append to RSS file
echo "$url" >> "$RSSFILE"
notify-send "RSS feed added: $url"
exit 0
