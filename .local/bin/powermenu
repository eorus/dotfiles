#!/bin/sh

# Auto-detect WM without wmctrl
WM="${XDG_SESSION_DESKTOP:-$DESKTOP_SESSION}"
WM=$(echo "$WM" | tr '[:upper:]' '[:lower:]')

case "$(readlink -f /sbin/init)" in
    *systemd*) ctl='systemctl' ;;
    *) ctl='loginctl' ;;
esac

wmpid() {
    for wm in i3 bspwm dwm xmonad; do
        pid=$(pgrep -x "$wm" | head -n1)
        [ -n "$pid" ] && echo "$pid" && return
    done
}

choice=$(printf "🔒 lock\n🚪 leave $WM\n♻️ renew $WM\n🐻 hibernate\n🔃 reboot\n🖥️ shutdown\n💤 sleep\n📺 display off" | dmenu -i -p 'Action: ')

case "$choice" in
    '🔒 lock') slock ;;
    "🚪 leave $WM") kill -TERM "$(wmpid)" ;;
    "♻️ renew $WM") kill -HUP "$(wmpid)" ;;
    '🐻 hibernate') slock && $ctl hibernate -i ;;
    '💤 sleep') slock && $ctl suspend -i ;;
    '🔃 reboot') $ctl reboot -i ;;
    '🖥️ shutdown') $ctl poweroff -i ;;
    '📺 display off') xset dpms force off ;;
    *) exit 1 ;;
esac
