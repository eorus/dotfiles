#!/usr/bin/env bash
set -euo pipefail

CARD="/mnt/import"
STAMP=$(date +%Y%m%d-%H%M%S)
TMP="$HOME/Pictures/CameraImport/incoming/$STAMP"
ARCHIVE_BASE="$HOME/Pictures/CameraArchive"
ARCHIVE_YEAR="$ARCHIVE_BASE/$(date +%Y)"
ARCHIVE_DEST="$ARCHIVE_YEAR/$(date +%m-%d)_import_$STAMP"
THUMBS="$ARCHIVE_BASE/thumbnails/$(date +%Y-%m-%d)"
EDITED_DIR="$ARCHIVE_DEST/Edited"

mkdir -p "$TMP" "$ARCHIVE_DEST" "$THUMBS" "$EDITED_DIR"

rsync -av --progress --no-perms "$CARD"/ "$TMP"/

exiftool '-FileModifyDate<DateTimeOriginal' -overwrite_original_in_place -ext RAF -ext JPG -r "$TMP" || true
exiftool '-Filename<CreateDate' -d %Y%m%d_%H%M%S%%-c.%%e -ext RAF -ext JPG -r "$TMP" || true

rsync -av --ignore-existing "$TMP"/ "$ARCHIVE_DEST"/

find "$ARCHIVE_DEST" -type f -iname '*.jpg' -print0 | while IFS= read -r -d '' src; do
  dst="$THUMBS/$(basename "$src")"
  [ -f "$dst" ] && continue
  mkdir -p "$(dirname "$dst")"
  magick "$src" -auto-orient -resize 1600x1600\> "$dst"
done

find "$ARCHIVE_DEST" -type f -iname '*.jpg' -print0 | while IFS= read -r -d '' src; do
  out="$EDITED_DIR/$(basename "$src")"
  [ -f "$out" ] && continue
  mkdir -p "$(dirname "$out")"
  magick "$src" -auto-orient +profile "*" -colorspace sRGB -auto-level -contrast-stretch 0.5%x0.5% -sharpen 0x0.8 "$out"
done

echo "Import complete."
echo "Archive: $ARCHIVE_DEST"
echo "Thumbnails: $THUMBS"
echo "Edited JPGs: $EDITED_DIR"
