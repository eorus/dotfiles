#!/bin/sh

# Check for package updates (official + AUR) and notify with meaningful details

# Initial notification
notify-send "ğŸ“¦ Checking for updates..." "Fetching package lists..."

# Sync official package database
sudo pacman -Sy --noconfirm || notify-send "âš ï¸ Error" "Failed to sync pacman database. Check your internet connection or pacman status."

# Check for official package updates
official_updates=$(pacman -Qu | grep -v "\[ignored\]")

# Check for AUR package updates
aur_updates=$(yay -Qua 2>/dev/null)

# Function to prepare notification text
prepare_summary() {
    local updates="$1"
    local count=$(echo "$updates" | wc -l)
    if [ "$count" -eq 0 ]; then
        echo ""
        return
    fi

    # Show up to 5 updates for brevity
    local summary=$(echo "$updates" | head -5)
    local extra=""
    if [ "$count" -gt 5 ]; then
        extra="â€¦and $((count - 5)) more"
    fi
    echo "$summary $extra"
}

# Prepare summaries
official_summary=$(prepare_summary "$official_updates")
aur_summary=$(prepare_summary "$aur_updates")

# Compose final message
message=""
if [ -n "$official_summary" ]; then
    message="ğŸ“¦ Official updates:\n$official_summary"
fi
if [ -n "$aur_summary" ]; then
    [ -n "$message" ] && message="$message\n\n"
    message="$messageğŸ›  AUR updates:\n$aur_summary"
fi

# Send notification
if [ -n "$message" ]; then
    total_count=$(( $(echo "$official_updates" | wc -l) + $(echo "$aur_updates" | wc -l) ))
    notify-send "ğŸ $total_count Updates Available" "$message"
else
    notify-send "ğŸ“¦ Up to Date" "No new packages available (official or AUR)."
fi
