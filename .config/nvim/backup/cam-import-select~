#!/usr/bin/env bash
set -euo pipefail

SRC="/mnt/import/DCIM"
BASE="$HOME/Pictures"

# --- 1Ô∏è‚É£ Find all JPG + RAF files recursively ---
files=$(find "$SRC" -type f \( -iname '*.JPG' -o -iname '*.RAF' \))
if [[ -z "$files" ]]; then
    echo "‚ùå No JPG or RAF files found in $SRC"
    exit 1
fi

read -p "Do you want to overwrite existing JPG/RAF files in destination? [y/n]: " ow

declare -A seen_dates

# --- 2Ô∏è‚É£ Import & organize by shooting date ---
for f in $files; do
    date=$(exiftool -s3 -d "%Y-%m-%d" -DateTimeOriginal "$f" 2>/dev/null || true)
    if [[ -z "$date" ]]; then
        echo "‚ö†Ô∏è No DateTimeOriginal for $f, skipping"
        continue
    fi

    year=${date:0:4}
    DEST="$BASE/$year/$date"

    # Create folders
    mkdir -p "$DEST/JPG" "$DEST/RAF" "$DEST/Edited" "$DEST/Selected"

    # Copy depending on extension
    ext="${f##*.}"
    ext_upper=$(echo "$ext" | tr '[:lower:]' '[:upper:]')
    if [[ "$ext_upper" == "JPG" ]]; then
        if [[ "$ow" == "y" ]]; then
            rsync -av --progress "$f" "$DEST/JPG/"
        else
            rsync -av --progress --ignore-existing "$f" "$DEST/JPG/"
        fi
    elif [[ "$ext_upper" == "RAF" ]]; then
        if [[ "$ow" == "y" ]]; then
            rsync -av --progress "$f" "$DEST/RAF/"
        else
            rsync -av --progress --ignore-existing "$f" "$DEST/RAF/"
        fi
    fi

    seen_dates["$date"]=1
done

# --- 3Ô∏è‚É£ Show import stats ---
for d in "${!seen_dates[@]}"; do
    year=${d:0:4}
    JPG_COUNT=$(find "$BASE/$year/$d/JPG" -type f -iname '*.JPG' | wc -l)
    RAF_COUNT=$(find "$BASE/$year/$d/RAF" -type f -iname '*.RAF' | wc -l)
    echo "üìÇ $BASE/$year/$d -> JPGs: $JPG_COUNT, RAFs: $RAF_COUNT"
done

# --- 4Ô∏è‚É£ Optional auto-enhance ---
read -p "Do you want to auto-enhance all JPGs in every folder? [y/n]: " enh
if [[ "$enh" == "y" ]]; then
    for d in "${!seen_dates[@]}"; do
        year=${d:0:4}
        echo "‚ú® Enhancing JPGs for $d ..."
        cp "$BASE/$year/$d/JPG"/*.JPG "$BASE/$year/$d/Edited"/ 2>/dev/null || true
        mogrify -auto-level -brightness-contrast 10x5 -modulate 100,120,100 "$BASE/$year/$d/Edited"/*.JPG
        echo "   Done -> $BASE/$year/$d/Edited"
    done
fi

# --- 5Ô∏è‚É£ Fast browsing + marking workflow using nsxiv ---
read -p "Do you want to browse and mark JPGs into Selected/ folders? [y/n]: " browse
if [[ "$browse" == "y" ]]; then
    mark_image() {
        img="$1"
        dest_dir="$(dirname "$img")/Selected"
        cp "$img" "$dest_dir/"
        echo "‚úÖ Marked: $(basename "$img") ‚Üí $dest_dir"
    }
    export -f mark_image

    for d in "${!seen_dates[@]}"; do
        year=${d:0:4}
        DIR="$BASE/$year/$d/JPG"
        echo "üîπ Browsing $DIR ..."
        sxiv -f -F "$DIR" 'mark_image %f'
        # Options:
        # -R recursive
        # -f fullscreen / fit to window
        # -F no frame
        # -c for custom keybinds (t = mark)
    done
fi

echo "‚úÖ Import workflow complete!"
