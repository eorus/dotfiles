#!/usr/bin/env bash
# Ultra-lightweight DWM statusbar for X220

while true; do
    # --- TIME ---
    TIME="ðŸ•’ $(date '+%H:%M %d-%b')"

    # --- BATTERY ---
    if [ -f /sys/class/power_supply/BAT0/capacity ]; then
        BAT_CAP=$(cat /sys/class/power_supply/BAT0/capacity)
        BAT_STAT=$(cat /sys/class/power_supply/BAT0/status)
        BAT_TEXT="ðŸ”‹ $BAT_CAP% $BAT_STAT"
    else
        BAT_TEXT="No BAT"
    fi

    # --- CPU LOAD ---
    CPU_LOAD=$(awk '{print $1}' /proc/loadavg)
    CPU_TEXT="ðŸ–¥ $CPU_LOAD"

    # --- VOLUME ---
    VOL_RAW=$(amixer get Master | awk -F'[][]' 'END{ print $2 " " $4 }')
    VOL_PERCENT=$(echo $VOL_RAW | awk '{print $1}' | tr -d '%')
    VOL_MUTE=$(echo $VOL_RAW | awk '{print $2}')
    if [ "$VOL_MUTE" = "off" ] || [ "$VOL_PERCENT" = "0" ]; then
        VOL_TEXT="ðŸ”ˆ Mute"
    else
        VOL_TEXT="ðŸ”Š $VOL_RAW"
    fi

    # --- Wi-Fi / IP ---
    NET_TEXT=""
    for iface in /sys/class/net/*; do
        iface_name=$(basename "$iface")
        state=$(cat "$iface/operstate")
        if [[ "$iface_name" == w* && "$state" == "up" ]]; then
            IP=$(ip -4 addr show "$iface_name" | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
            NET_TEXT="ðŸ“¶ $IP"
            break
        fi
    done

    # --- Root disk usage ---
    DISK=$(df -h --output=pcent / | tail -1)
    DISK_TEXT="ðŸ’¾$DISK"

    # --- CPU temperature ---
    if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
        TEMP=$(awk '{printf "%.1f", $1/1000}' /sys/class/thermal/thermal_zone0/temp)
        TEMP_TEXT="ðŸŒ¡ $TEMPÂ°C"
    else
        TEMP_TEXT=""
    fi

    # --- Combine and set status ---
    STATUS="$BAT_TEXT | $CPU_TEXT | $VOL_TEXT | $DISK_TEXT | $TEMP_TEXT | $TIME"
    xsetroot -name "$STATUS"

    sleep 5
done
